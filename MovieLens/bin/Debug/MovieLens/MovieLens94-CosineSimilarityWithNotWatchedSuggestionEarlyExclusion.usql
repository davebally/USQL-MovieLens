// Generated Code Behind Header

CREATE ASSEMBLY [__codeBehind_tvu5fprm.hiz] FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300EE1FED560000000000000000E00002210B010B00000600000006000000000000DE240000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000882400005300000000400000E802000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000E4040000002000000006000000020000000000000000000000000000200000602E72737263000000E8020000004000000004000000080000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000000C00000000000000000000000000004000004200000000000000000000000000000000C0240000000000004800000002000500A4200000E403000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B3002003000000001000011036F0300000A0C2B0F086F0400000A0A06023304170BDE16086F0500000A2DE9DE0A082C06086F0600000ADC162A072A01100000020007001B22000A000000001E02280700000A2A42534A4201000100000000000C00000076342E302E33303331390000000005006C00000038010000237E0000A4010000B001000023537472696E6773000000005403000008000000235553005C0300001000000023475549440000006C0300007800000023426C6F620000000000000002000001471502080900000000FA253300160000010000000700000002000000020000000200000007000000020000000100000002000000010000000200000000000A000100000000000600470040000A00860068000600D600B6000600F600B600060049012E0106008401710106009901400000000000010000000000010001000100100028002D0005000100010050200000000096009100130001009C20000000008618A0001D00030000000100A60000000200AC001900A00021002100A0001D000C0057012C00140065013B003100900140003900A5011D000900A0001D002E000B004E002E00130057004400260035000480000000000000000000000000000000001401000004000000000000000000000001003700000000000100000000000000000000000A004E00000000000000003C4D6F64756C653E005F5F636F6465426568696E645F747675356670726D2E68697A2E646C6C0075646673004D6F7669654C656E73006D73636F726C69620053797374656D004F626A656374004D6963726F736F66742E416E616C79746963732E5479706573004D6963726F736F66742E416E616C79746963732E54797065732E53716C0053716C4172726179603100546573744D6F766965496E417272002E63746F72004D6F766965004D6F7669654C6973740053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465005F5F636F6465426568696E645F747675356670726D2E68697A0053797374656D2E436F6C6C656374696F6E732E47656E657269630049456E756D657261746F72603100476574456E756D657261746F72006765745F43757272656E740053797374656D2E436F6C6C656374696F6E730049456E756D657261746F72004D6F76654E6578740049446973706F7361626C6500446973706F7365000000000003200000000000E1E01D7A3506FA42A1B31581A6A49E6B0008B77A5C561934E089089F877B68B06E0B5E09000208081512090108032000010420010108051512090108082000151215011300051512150108042000130003200002090703080815121501080801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010000B02400000000000000000000CE240000002000000000000000000000000000000000000000000000C024000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000008C02000000000000000000008C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004EC010000010053007400720069006E006700460069006C00650049006E0066006F000000C801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000005C001E00010049006E007400650072006E0061006C004E0061006D00650000005F005F0063006F006400650042006500680069006E0064005F0074007600750035006600700072006D002E00680069007A002E0064006C006C0000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000064001E0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000005F005F0063006F006400650042006500680069006E0064005F0074007600750035006600700072006D002E00680069007A002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E00300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000E03400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
REFERENCE ASSEMBLY [__codeBehind_tvu5fprm.hiz];

DEPLOY RESOURCE @"C:\Users\daveb\Source\LocalRunDataRoot\MovieLensExtractor.dll";
DEPLOY RESOURCE @"C:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\.NETFramework\v4.5.2\System.Core.dll";
// Generated Code Behind Header
DECLARE @INPUTDIR string =  "/ml-20m/";
DECLARE @RATINGSInp string = @INPUTDIR + "ratings.dat";
DECLARE @USERSInp string = @INPUTDIR + "users.dat";

@RatingsRaw =
    EXTRACT RatingLine string
    FROM @RATINGSInp
    USING Extractors.Tsv( rowDelimiter: "\n");

@RatingsSplit =
    SELECT RatingLine,new SQL.ARRAY<string>(
           RatingLine.Split(new string[]{"::"},StringSplitOptions.None)) AS Ratings
    FROM @RatingsRaw;

@Ratings =
    SELECT int.Parse(Ratings[0]) AS MovieID,
           int.Parse(Ratings[1]) AS UserID,
           int.Parse(Ratings[2]) AS Rating,
           Ratings[3] AS Timestamp
FROM @RatingsSplit;

@AvgRating =
    SELECT MovieID,
           AVG(Rating) AS AvgRating
    FROM @Ratings
    GROUP BY MovieID;


@UsersRaw =
    EXTRACT UserLine string
    FROM @USERSInp
    USING Extractors.Tsv( rowDelimiter: "\n");

@UsersSplit =
    SELECT UserLine,new SQL.ARRAY<string>(
           UserLine.Split(new string[]{"::"},StringSplitOptions.None)) AS UserArr
    FROM @UsersRaw;


@Users =
    SELECT int.Parse(UserArr[0]) AS UserID,
           UserArr[1] AS Gender,
           int.Parse(UserArr[2])  AS Age,
           int.Parse(UserArr[3]) AS Occupation,
           UserArr[4] AS Zip
FROM @UsersSplit;


@CrossJoin =
    SELECT a.UserID AS aUserID,
           b.UserID AS bUserID
    FROM @Users AS a
         JOIN
             @Users AS b
         ON a.Age == b.Age
         AND a.Occupation == b.Occupation  // New Filter
WHERE a.UserID != b.UserID;


@CrossJoinWithMovies =
    SELECT aUserID,
           bUserID,
           Ratings.MovieID AS UnseenMovieID
    FROM @CrossJoin AS cj
         JOIN
             @Ratings AS Ratings
         ON cj.bUserID == Ratings.UserID
         LEFT JOIN
             @Ratings AS aUserRatings
         ON cj.aUserID == aUserRatings.UserID
            AND aUserRatings.MovieID == Ratings.MovieID
    WHERE aUserRatings.UserID == NULL;


//OUTPUT @CrossJoinWithMovies
//TO "cjm.csv" 
//ORDER BY c DESC
//USING Outputters.Csv();

@CrossJoinRatings1 =
    SELECT aUserID,
           bUserID,
           r1.MovieID,
           r1.Rating AS aRating,
           r2.Rating AS bRating,
           Math.Pow(r1.Rating, 2) AS aRatingSQ,
           Math.Pow(r2.Rating, 2) AS bRatingSQ
    FROM @CrossJoin AS cj
         JOIN
             @Ratings AS r1
         ON cj.aUserID == r1.UserID
         JOIN
             @Ratings AS r2
         ON cj.bUserID == r2.UserID
            AND r1.MovieID == r2.MovieID;


@cj1 =
    SELECT aUserID,
           bUserID,
           SUM(aRating * bRating) AS r1,
           SUM(aRatingSQ) AS SumASquared,
           SUM(bRatingSQ) AS SumBSquared
    FROM @CrossJoinRatings1
    GROUP BY aUserID,
             bUserID;

@Similarity =
    SELECT aUserID,
           bUserID,
           (double) r1 / (Math.Sqrt((double) SumASquared) * Math.Sqrt((double) SumBSquared)) AS Similarity
    FROM @cj1 AS cj;


@suj =
    SELECT Similarity.*,
           ROW_NUMBER() OVER(PARTITION BY Similarity.aUserID ORDER BY Similarity.Similarity DESC, ar.AvgRating DESC) AS RowN,
           ar.MovieID AS RecommendedMovieID
    FROM @Similarity AS Similarity
         JOIN
             @Ratings AS r
         ON r.UserID == Similarity.bUserID
         JOIN
             @AvgRating AS ar
         ON ar.MovieID == r.MovieID
         JOIN
             @CrossJoinWithMovies AS crjMovies
         ON crjMovies.aUserID == Similarity.aUserID
            AND crjMovies.bUserID == Similarity.bUserID
            AND ar.MovieID == crjMovies.UnseenMovieID
    WHERE Similarity < 1
          AND Similarity >= .95;

@res =
    SELECT suj.aUserID AS UserID,
           suj.RecommendedMovieID
    FROM @suj AS suj
    WHERE RowN == 1;

OUTPUT @res
TO "Recommend.csv" 
USING Outputters.Csv();


// Generated Code Behind Footer
USE DATABASE [master];
USE SCHEMA [dbo];

DROP ASSEMBLY [__codeBehind_tvu5fprm.hiz];
// Generated Code Behind Footer
